name: CI JAVA
on:
  workflow_call:
    inputs:
      workflow:
        type: string
        required: true
      releaseId:
        type: string
        required: false
        default: ""
      projectId:
        type: string
        required: false
        default: ""
      region:
        type: string
        required: false
        default: "DIGITAL"
      csild:
        type: string
        required: false
        default: ""

      # Bloques anidados como JSON string
      sourceCode_json:
        type: string
        required: false
        default: |
          {"projectStream":"master","projectModule":"","repositoryInstance":"Github"}
      build_json:
        type: string
        required: false
        default: |
          {"dependencyResolutionRepo":"artifactory","printVerboseLog":false,"deployLibraries":false,"pomFileLocation":".","packageIncludes":"","jenkinsAdditionalFolder":"content","svnProfiles":"","tibcoBW":{"stpVersion":""},"deployToPkgArchive":true}
      staticCodeAnalysis_json:
        type: string
        required: false
        default: |
          {"blackDuck":{"RELEASENAME":"","BD_ARCHER_COMPONENT":"","SCAN_WF":"","BD_SOURCE_SYSTEM":""},
           "checkmarx":{"CHECKMARX_CONFIG_CMPNAME":"","CHECKMARX_ENV":"","SCAN_WF":"","CHECKMARX_CX_TEAMNAME":"","CHECKMARX_ARCHER_BASE_CMPNAME":"","CHECKMARX_TYPE_WF_SCAN":"","RELEASENAME":""},
           "sonarQube":{"sonarExcludes":"","sonarLanguage":""},
           "appscan":{"archerRecord":""}}
      threshold_json:
        type: string
        required: false
        default: |
          {"unitTestSuccessDensity":0,"securityRating":0,"techDebtRatio":0,"reliabilityRating":0,"unitTestCoverage":0}
      deploy_json:
        type: string
        required: false
        default: |
          {"NA":{"rlmExecute":false,"rlmEnvironment":"","rlmParams":"","rlmUIParams":"","rlmTemplate":""},
           "SWSDEVTEST":{"rlmExecute":true,"rlmEnvironment":"","rlmParams":"","rlmUIParams":"","rlmTemplate":""}}

      postBuildDeployEnv:
        type: string
        required: false
        default: ""

jobs:
  pipeline-ci-java:
    runs-on: ubuntu-latest
    # Permisos necesarios para firmar (ej. con Sigstore) y
    # publicar en el registro de GitHub (GHCR)
    permissions:
      contents: read
      packages: write # Para 'docker push' a GHCR
      id-token: write # Para autenticación 'keyless' de Sigstore/cosign
    env:
      # escala simple
      WORKFLOW: ${{ inputs.workflow }}
      RELEASE_ID: ${{ inputs.releaseId }}
      PROJECT_ID: ${{ inputs.projectId }}
      REGION: ${{ inputs.region }}
      CSILD: ${{ inputs.csild }}

      # parseo JSON a nivel de env cuando conviene (campos más usados)
      SOURCE_PROJECT_STREAM: ${{ fromJSON(inputs.sourceCode_json).projectStream }}
      SOURCE_PROJECT_MODULE: ${{ fromJSON(inputs.sourceCode_json).projectModule }}
      SOURCE_REPO_INSTANCE: ${{ fromJSON(inputs.sourceCode_json).repositoryInstance }}

      BUILD_VERBOSE: ${{ fromJSON(inputs.build_json).printVerboseLog }}
      BUILD_DEPLOY_LIBS: ${{ fromJSON(inputs.build_json).deployLibraries }}
      BUILD_POM: ${{ fromJSON(inputs.build_json).pomFileLocation }}
      BUILD_DEPLOY_TO_ARCHIVE: ${{ fromJSON(inputs.build_json).deployToPkgArchive }}

      # thresholds
      THRESH_UT_SUCCESS: ${{ fromJSON(inputs.threshold_json).unitTestSuccessDensity }}
      THRESH_SEC: ${{ fromJSON(inputs.threshold_json).securityRating }}
      THRESH_TD: ${{ fromJSON(inputs.threshold_json).techDebtRatio }}
      THRESH_REL: ${{ fromJSON(inputs.threshold_json).reliabilityRating }}
      THRESH_COV: ${{ fromJSON(inputs.threshold_json).unitTestCoverage }}

      POST_BUILD_DEPLOY_ENV: ${{ inputs.postBuildDeployEnv }}

    steps:
      - name: 1. Checkout del código
        uses: actions/checkout@v4
        with:
          # Necesario para que SonarCloud analice correctamente el historial de PRs
          # '0' significa clonar todo el historial.
          fetch-depth: 0  

      - name: 2. Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: 3. (Opcional) Configurar Caché de Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 4. Construir y Probar con Maven
        # Este paso es CRÍTICO.
        # SonarCloud necesita los archivos .class (compilados) y los reportes
        # de cobertura de pruebas (generados por 'verify') para un buen análisis.
        run: mvn -B verify --file pom.xml

      - name: 5. Ejecutar Scan de SonarCloud
        uses: SonarSource/sonarcloud-github-action@master
        env:
          # Token de GitHub (integrado) para decorar el Pull Request
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
          # Token de SonarCloud (que creamos en el Paso 2)
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # (Opcional) Si tu pom.xml no está en la raíz
          # projectBaseDir: . 
          args: >
            -Dsonar.organization=PoC-Pipeline-Conversion-Jenkins-GHA
            -Dsonar.projectKey=CICD-PoC-Jenkins-a-GHA